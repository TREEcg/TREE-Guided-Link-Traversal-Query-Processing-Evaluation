{"version":3,"file":"ForgotPasswordHandler.js","sourceRoot":"","sources":["../../../../../src/identity/interaction/email-password/handler/ForgotPasswordHandler.ts"],"names":[],"mappings":";;;;;;AAAA,oDAA4B;AAC5B,6FAA0F;AAE1F,yDAA2D;AAC3D,gEAAiE;AACjE,4DAA6D;AAE7D,yEAAsE;AAMtE,MAAM,kBAAkB,GAAG;IACzB,QAAQ,EAAE;QACR,KAAK,EAAE,QAAQ;KAChB;CACO,CAAC;AASX;;GAEG;AACH,MAAa,qBAAsB,SAAQ,+CAAsB;IAQ/D,YAAmB,IAA+B;QAChD,KAAK,CAAC,kBAAkB,CAAC,CAAC;QART,WAAM,GAAG,IAAA,sBAAY,EAAC,IAAI,CAAC,CAAC;QAS7C,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,YAAY,CAAC;QACtC,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,cAAc,CAAC;QAC1C,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC;QACpC,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC;IACpC,CAAC;IAEM,KAAK,CAAC,UAAU,CAAC,EAAE,SAAS,EAA2B;QAC5D,yBAAyB;QACzB,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAA,2BAAc,EAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAC5D,IAAA,gBAAM,EAAC,OAAO,KAAK,KAAK,QAAQ,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,gBAAgB,CAAC,CAAC;QAExE,MAAM,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QAChC,OAAO,IAAI,yCAAmB,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,CAAC,EAAE,SAAS,CAAC,MAAM,EAAE,+BAAgB,CAAC,CAAC;IAChG,CAAC;IAED;;;;OAIG;IACK,KAAK,CAAC,aAAa,CAAC,KAAa;QACvC,IAAI,QAAgB,CAAC;QACrB,IAAI;YACF,QAAQ,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,4BAA4B,CAAC,KAAK,CAAC,CAAC;SACxE;QAAC,MAAM;YACN,0CAA0C;YAC1C,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,4CAA4C,KAAK,EAAE,CAAC,CAAC;YACtE,OAAO;SACR;QACD,MAAM,IAAI,CAAC,aAAa,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;IAC5C,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,aAAa,CAAC,QAAgB,EAAE,KAAa;QACzD,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,6BAA6B,KAAK,EAAE,CAAC,CAAC;QACvD,MAAM,SAAS,GAAG,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,QAAQ,kBAAkB,CAAC,QAAQ,CAAC,EAAE,CAAC;QACrF,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,CAAC,CAAC;QACtE,MAAM,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC;YAChC,SAAS,EAAE,KAAK;YAChB,OAAO,EAAE,qBAAqB;YAC9B,IAAI,EAAE,4CAA4C,SAAS,EAAE;YAC7D,IAAI,EAAE,aAAa;SACpB,CAAC,CAAC;IACL,CAAC;CACF;AAxDD,sDAwDC","sourcesContent":["import assert from 'assert';\nimport { BasicRepresentation } from '../../../../http/representation/BasicRepresentation';\nimport type { Representation } from '../../../../http/representation/Representation';\nimport { getLoggerFor } from '../../../../logging/LogUtil';\nimport { APPLICATION_JSON } from '../../../../util/ContentTypes';\nimport { readJsonStream } from '../../../../util/StreamUtil';\nimport type { TemplateEngine } from '../../../../util/templates/TemplateEngine';\nimport { BaseInteractionHandler } from '../../BaseInteractionHandler';\nimport type { InteractionHandlerInput } from '../../InteractionHandler';\nimport type { InteractionRoute } from '../../routing/InteractionRoute';\nimport type { AccountStore } from '../storage/AccountStore';\nimport type { EmailSender } from '../util/EmailSender';\n\nconst forgotPasswordView = {\n  required: {\n    email: 'string',\n  },\n} as const;\n\nexport interface ForgotPasswordHandlerArgs {\n  accountStore: AccountStore;\n  templateEngine: TemplateEngine<{ resetLink: string }>;\n  emailSender: EmailSender;\n  resetRoute: InteractionRoute;\n}\n\n/**\n * Handles the submission of the ForgotPassword form\n */\nexport class ForgotPasswordHandler extends BaseInteractionHandler {\n  protected readonly logger = getLoggerFor(this);\n\n  private readonly accountStore: AccountStore;\n  private readonly templateEngine: TemplateEngine<{ resetLink: string }>;\n  private readonly emailSender: EmailSender;\n  private readonly resetRoute: InteractionRoute;\n\n  public constructor(args: ForgotPasswordHandlerArgs) {\n    super(forgotPasswordView);\n    this.accountStore = args.accountStore;\n    this.templateEngine = args.templateEngine;\n    this.emailSender = args.emailSender;\n    this.resetRoute = args.resetRoute;\n  }\n\n  public async handlePost({ operation }: InteractionHandlerInput): Promise<Representation> {\n    // Validate incoming data\n    const { email } = await readJsonStream(operation.body.data);\n    assert(typeof email === 'string' && email.length > 0, 'Email required');\n\n    await this.resetPassword(email);\n    return new BasicRepresentation(JSON.stringify({ email }), operation.target, APPLICATION_JSON);\n  }\n\n  /**\n   * Generates a record to reset the password for the given email address and then mails it.\n   * In case there is no account, no error wil be thrown for privacy reasons.\n   * Instead nothing will happen instead.\n   */\n  private async resetPassword(email: string): Promise<void> {\n    let recordId: string;\n    try {\n      recordId = await this.accountStore.generateForgotPasswordRecord(email);\n    } catch {\n      // Don't emit an error for privacy reasons\n      this.logger.warn(`Password reset request for unknown email ${email}`);\n      return;\n    }\n    await this.sendResetMail(recordId, email);\n  }\n\n  /**\n   * Generates the link necessary for resetting the password and mails it to the given email address.\n   */\n  private async sendResetMail(recordId: string, email: string): Promise<void> {\n    this.logger.info(`Sending password reset to ${email}`);\n    const resetLink = `${this.resetRoute.getPath()}?rid=${encodeURIComponent(recordId)}`;\n    const renderedEmail = await this.templateEngine.render({ resetLink });\n    await this.emailSender.handleSafe({\n      recipient: email,\n      subject: 'Reset your password',\n      text: `To reset your password, go to this link: ${resetLink}`,\n      html: renderedEmail,\n    });\n  }\n}\n"]}